<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shop | MiniTorque</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <%- include("../partials/head") %>

        <style>
            /* ====== RESET ====== */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                background: #f8f9fa;
                color: #333;
            }

            /* ====== SHOP HEADER ====== */
            .shop-header {
                background: #fff;
                padding: 40px 0;
                margin-bottom: 30px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
            }

            /* ====== FILTERS ====== */
            .filters-container {
                position: sticky;
                top: 90px;
                background: #fff;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
            }

            .filter-group {
                margin-bottom: 20px;
            }

            .filter-label {
                font-weight: 600;
                color: #333;
                margin-bottom: 8px;
                display: block;
                font-size: 14px;
            }

            .filter-select,
            .form-control {
                width: 100%;
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 6px;
                font-size: 14px;
                color: #333;
                background: #fff;
                transition: border-color .2s ease;
            }

            .filter-select:focus,
            .form-control:focus {
                outline: none;
                border-color: #dc3545;
                box-shadow: 0 0 0 2px rgba(220, 53, 69, .1);
            }

            .form-control.error {
                border-color: #dc3545;
                background: #fff5f5;
            }

            .error-message {
                color: #dc3545;
                font-size: 12px;
                margin-top: 4px;
                display: none;
            }

            .validation-message {
                font-size: 12px;
                margin-top: 4px;
                display: none;
            }

            .validation-message.show {
                display: block;
            }

            .validation-message.error {
                color: #dc3545;
            }

            .validation-message.success {
                color: #28a745;
            }

            .validation-message.warning {
                color: #ffc107;
            }

            .validation-message.info {
                color: #000000;
            }

            .form-check {
                margin-bottom: 8px;
            }

            .form-check-input {
                border-color: #000;
            }

            .form-check-input:checked {
                background-color: #fff;
                border-color: #000;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23000'/%3e%3c/svg%3e");
            }

            .form-check-input:focus {
                border-color: #000;
                box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
            }

            /* ====== PRODUCTS ====== */
            .product-card {
                transition: .3s;
                border-radius: .5rem;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0, 0, 0, .05);
                background: #fff;
                height: 100%;
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, .1);
            }

            .product-image-container {
                position: relative;
                overflow: hidden;
                height: 250px;
            }

            .product-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: .3s;
                cursor: pointer;
            }

            .product-card:hover .product-image {
                transform: scale(1.05);
            }

            .product-badge {
                position: absolute;
                top: 10px;
                left: 10px;
                background: #dc3545;
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                z-index: 2;
            }

            .wishlist-icon {
                position: absolute;
                bottom: 10px;
                right: 10px;
                width: 35px;
                height: 35px;
                background: rgba(255, 255, 255, .9);
                border: none;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: .3s;
                z-index: 3;
                box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
            }

            .wishlist-icon:hover {
                background: #fff;
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            }

            .wishlist-icon i {
                font-size: 16px;
                color: #666;
                transition: .3s;
            }

            .wishlist-icon:hover i {
                color: #dc3545;
                transform: scale(1.1);
            }

            .wishlist-icon.active i {
                color: #dc3545;
            }

            .product-info {
                padding: 15px;
            }

            .product-brand {
                color: #6c757d;
                font-size: 13px;
                margin-bottom: 5px;
                text-transform: uppercase;
            }

            .product-title {
                font-size: 16px;
                font-weight: 600;
                color: #333;
                margin-bottom: 10px;
                line-height: 1.4;
                height: 2.8em;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                -webkit-box-orient: vertical;
            }

            .product-price {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
            }

            .price-section {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .current-price {
                font-size: 18px;
                font-weight: bold;
                color: #333;
            }

            .original-price {
                font-size: 14px;
                color: #6c757d;
                text-decoration: line-through;
            }

            .add-to-cart {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 9999px;
                background: #000;
                color: #fff;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: .3s;
                cursor: pointer;
            }

            .add-to-cart:hover {
                background: #333;
                transform: scale(1.1);
            }

            .add-to-cart:disabled {
                background: #6c757d;
                cursor: not-allowed;
                transform: none;
            }

            /* ====== PAGINATION ====== */
            .pagination {
                justify-content: center;
            }

            .page-item {
                margin: 0 2px;
            }

            .page-link {
                color: #333;
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 8px 12px;
                transition: .2s;
            }

            .page-item.active .page-link {
                background: #dc3545;
                border-color: #dc3545;
                color: #fff;
            }

            .page-link:hover {
                color: #dc3545;
                border-color: #dc3545;
                background: #f8f9fa;
            }

            .page-item.disabled .page-link {
                color: #6c757d;
                border-color: #dee2e6;
                background: #f8f9fa;
                cursor: not-allowed;
            }

            /* ====== RESPONSIVE ====== */
            @media (max-width:991.98px) {
                .filters-container {
                    position: relative;
                    top: 0;
                }
            }

            @media (max-width:480px) {
                .product-image-container {
                    height: 200px;
                }

                .shop-header {
                    padding: 20px 0;
                }

                .pagination {
                    flex-wrap: wrap;
                }

                .page-item {
                    margin: 2px;
                }

                .page-link {
                    padding: 6px 10px;
                    font-size: 14px;
                }
            }
        </style>
</head>

<body>

    <!-- ====================  SHOP HEADER  ==================== -->
    <section class="shop-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-5 fw-bold mb-3">Shop Collection</h1>
                    <p class="text-muted mb-0">Premium diecast models from the world's finest automotive brands.</p>
                </div>
                <div class="col-lg-6">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb justify-content-lg-end mb-0">
                            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Home</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Shop</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- ====================  SHOP CONTENT  ==================== -->
    <section class="py-5 bg-white">
        <div class="container">
            <div class="row g-4">
                <!-- =====  FILTER SIDEBAR  ===== -->
                <div class="col-lg-3">
                    <div class="filters-container">
                        <h3 class="fs-5 fw-bold mb-4">Filters</h3>

                        <form method="GET" action="/shopPage" id="filterForm" novalidate>
                            <!-- Search -->
                            <div class="filter-group">
                                <label class="filter-label">Search Products</label>
                                <input type="text" name="search" class="form-control"
                                    placeholder="Search by name or brand..." value="<%= filters.search %>"
                                    maxlength="100">
                            </div>

                            <!-- Categories -->
                            <div class="filter-group">
                                <label class="filter-label">Categories</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="category" value="all"
                                        id="allCategories" <%=!filters.category || filters.category==='all' ? 'checked'
                                        : '' %>>
                                    <label class="form-check-label" for="allCategories">All Categories</label>
                                </div>
                                <% if (categories && categories.length){ %>
                                    <% categories.forEach(cat=>{ %>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="category"
                                                value="<%= cat._id %>" id="cat_<%= cat._id %>"
                                                <%=filters.category===cat._id.toString() ? 'checked' : '' %>
                                            <label class="form-check-label" for="cat_<%= cat._id %>">
                                                <%= cat.name %>
                                            </label>
                                        </div>
                                        <% }) %>
                                            <% } %>
                            </div>

                            <!-- Price -->
                            <div class="filter-group">
                                <label class="filter-label">Price Range (Optional)</label>
                                <div class="d-flex gap-2">
                                    <div class="flex-fill">
                                        <input type="number" name="minPrice" id="minPriceInput" class="form-control"
                                            placeholder="Min ₹" min="0" max="999999" step="1"
                                            value="<%= filters.minPrice %>">
                                        <div id="minPriceMessage" class="validation-message"></div>
                                    </div>
                                    <div class="flex-fill">
                                        <input type="number" name="maxPrice" id="maxPriceInput" class="form-control"
                                            placeholder="Max ₹" min="0" max="999999" step="1"
                                            value="<%= filters.maxPrice %>">
                                        <div id="maxPriceMessage" class="validation-message"></div>
                                    </div>
                                </div>
                                <div id="priceRangeMessage" class="validation-message"></div>
                                <small class="text-muted mt-1">Leave empty to show all prices</small>
                            </div>

                            <!-- Availability -->
                            <div class="filter-group">
                                <label class="filter-label">Availability</label>
                                <select name="availability" class="filter-select">
                                    <option value="">All Products</option>
                                    <option value="in-stock" <%=filters.availability==='in-stock' ? 'selected' : '' %>
                                        >In Stock</option>
                                    <option value="on-sale" <%=filters.availability==='on-sale' ? 'selected' : '' %>>On
                                        Sale</option>
                                </select>
                            </div>

                            <!-- Sort -->
                            <div class="filter-group">
                                <label class="filter-label">Sort By</label>
                                <select name="sort" class="filter-select">
                                    <option value="newest" <%=filters.sort==='newest' ? 'selected' :'' %>>Newest First
                                    </option>
                                    <option value="oldest" <%=filters.sort==='oldest' ? 'selected' :'' %>>Oldest First
                                    </option>
                                    <option value="price-low" <%=filters.sort==='price-low' ? 'selected' :'' %>>Price:
                                        Low to High</option>
                                    <option value="price-high" <%=filters.sort==='price-high' ? 'selected' :'' %>>Price:
                                        High to Low</option>
                                    <option value="name-az" <%=filters.sort==='name-az' ? 'selected' :'' %>>Name: A to Z
                                    </option>
                                    <option value="name-za" <%=filters.sort==='name-za' ? 'selected' :'' %>>Name: Z to A
                                    </option>
                                </select>
                            </div>

                            <!-- Buttons -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-dark flex-fill" id="applyFiltersBtn">
                                    <i class="fas fa-filter me-1"></i>Apply Filters
                                </button>
                                <a href="/shopPage" class="btn btn-outline-secondary flex-fill text-center">
                                    <i class="fas fa-refresh me-1"></i>Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- =====  PRODUCT GRID  ===== -->
                <div class="col-lg-9">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap products-header">
                        <div class="products-count mb-2 mb-md-0">
                            <span class="fw-medium">
                                Showing
                                <% if (products && products.length){ %>
                                    <% const startItem=(pagination.currentPage-1)*12+1; %>
                                        <% const endItem=Math.min(pagination.currentPage*12,totalProducts); %>
                                            <%= startItem %> to <%= endItem %>
                                                    <% } else { %>0<% } %>
                                                            of <%= totalProducts %> products
                            </span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2 text-muted d-none d-sm-block">View:</span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm active"><i
                                        class="fas fa-th"></i></button>
                                <button type="button" class="btn btn-outline-secondary btn-sm"><i
                                        class="fas fa-list"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Grid -->
                    <div class="row g-4" id="productGrid">
                        <% if (products && products.length){ %>
                            <% products.forEach(product=>{ %>
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="product-card">
                                        <div class="product-image-container">
                                            <% if (product.productOffer && product.productOffer>0){ %>
                                                <div class="product-badge">
                                                    <%= product.productOffer %>% OFF
                                                </div>
                                                <% } %>

                                                    <!--  UPDATED WISHLIST BUTTON -->
                                                    <button
                                                        class="wishlist-icon <%= userWishlistIds.includes(product._id.toString()) ? 'active' : '' %>"
                                                        data-product-id="<%= product._id %>"
                                                        onclick="toggleWishlistFromShop('<%= product._id %>', this)"
                                                        title="<%= userWishlistIds.includes(product._id.toString()) ? 'Remove from Wishlist' : 'Add to Wishlist' %>">
                                                        <i
                                                            class="<%= userWishlistIds.includes(product._id.toString()) ? 'fas fa-heart text-danger' : 'far fa-heart' %>"></i>
                                                    </button>

                                                    <img src="/uploads/products/<%= product.mainImage %>"
                                                        class="product-image" alt="<%= product.productName %>"
                                                        onerror="this.src='/assets/placeholder.jpg'"
                                                        onclick="viewProduct('<%= product._id %>')">
                                        </div>
                                        <div class="product-info">
                                            <div class="product-brand">
                                                <%= product.brand %>
                                            </div>
                                            <h5 class="product-title" title="<%= product.productName %>">
                                                <%= product.productName %>
                                            </h5>
                                            <div class="product-price">
                                                <div class="price-section">
                                                    <% if (product.productOffer && product.productOffer>0){ %>
                                                        <% const
                                                            finalPrice=(product.salePrice*(1-product.productOffer/100)).toFixed(2);
                                                            %>
                                                            <span class="current-price">₹<%= finalPrice %></span>
                                                            <span class="original-price">₹<%=
                                                                    product.salePrice.toFixed(2) %></span>
                                                            <% } else { %>
                                                                <span class="current-price">₹<%=
                                                                        product.salePrice.toFixed(2) %></span>
                                                                <% } %>
                                                </div>
                                                <button class="add-to-cart" onclick="addToCart('<%= product._id %>')"
                                                    <%=product.quantity===0 ? 'disabled' : '' %>
                                                    title="<%= product.quantity===0 ? 'Out of Stock' : 'Add to Cart' %>
                                                        ">
                                                        <i
                                                            class="fas fa-<%= product.quantity === 0 ? 'times' : 'plus' %>"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <div class="col-12 text-center py-5">
                                            <i class="fas fa-search fa-3x text-muted mb-3" style="opacity:.3;"></i>
                                            <h3 class="mb-3">No Products Found</h3>
                                            <p class="text-muted mb-4">We couldn't find any products matching your
                                                criteria.</p>
                                            <a href="/shopPage" class="btn btn-primary"><i
                                                    class="fas fa-refresh me-2"></i>Clear All Filters</a>
                                        </div>
                                        <% } %>
                    </div>


                    <!-- Pagination -->
                    <% if (pagination && pagination.totalPages> 1) { %>
                        <div class="d-flex justify-content-center mt-5">
                            <nav aria-label="Product pagination">
                                <ul class="pagination">
                                    <!-- Previous Page Button -->
                                    <li class="page-item <%= pagination.hasPrevPage ? '' : 'disabled' %>">
                                        <a class="page-link"
                                            href="<%= pagination.hasPrevPage ? `?page=${pagination.prevPage}${queryString}` : '#' %>"
                                            aria-label="Previous Page" <%=!pagination.hasPrevPage ? 'tabindex="-1"' : ''
                                            %>>
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>

                                    <!-- First page and ellipsis logic -->
                                    <% if (pagination.currentPage> 3 && pagination.totalPages > 5) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1<%= queryString %>">1</a>
                                        </li>
                                        <% if (pagination.currentPage> 4) { %>
                                            <li class="page-item disabled">
                                                <span class="page-link">...</span>
                                            </li>
                                            <% } %>
                                                <% } %>

                                                    <!-- Page numbers -->
                                                    <% pagination.pages.forEach(pg=> { %>
                                                        <li
                                                            class="page-item <%= pg === pagination.currentPage ? 'active' : '' %>">
                                                            <a class="page-link"
                                                                href="?page=<%= pg %><%= queryString %>"
                                                                <%=pg===pagination.currentPage ? 'aria-current="page"'
                                                                : '' %>>
                                                                <%= pg %>
                                                            </a>
                                                        </li>
                                                        <% }) %>

                                                            <!-- Last page and ellipsis logic -->
                                                            <% if (pagination.currentPage < pagination.totalPages - 2 &&
                                                                pagination.totalPages> 5) { %>
                                                                <% if (pagination.currentPage < pagination.totalPages -
                                                                    3) { %>
                                                                    <li class="page-item disabled">
                                                                        <span class="page-link">...</span>
                                                                    </li>
                                                                    <% } %>
                                                                        <li class="page-item">
                                                                            <a class="page-link"
                                                                                href="?page=<%= pagination.totalPages %><%= queryString %>">
                                                                                <%= pagination.totalPages %>
                                                                            </a>
                                                                        </li>
                                                                        <% } %>

                                                                            <!-- Next Page Button -->
                                                                            <li
                                                                                class="page-item <%= pagination.hasNextPage ? '' : 'disabled' %>">
                                                                                <a class="page-link"
                                                                                    href="<%= pagination.hasNextPage ? `?page=${pagination.nextPage}${queryString}` : '#' %>"
                                                                                    aria-label="Next Page"
                                                                                    <%=!pagination.hasNextPage
                                                                                    ? 'tabindex="-1"' : '' %>>
                                                                                    <i class="fas fa-chevron-right"></i>
                                                                                </a>
                                                                            </li>
                                </ul>
                            </nav>
                        </div>
                        <% } %>

                            <!-- Optional: Show results info when there are products -->
                            <% if (products && products.length> 0) { %>
                                <div class="d-flex justify-content-center mt-3">
                                    <small class="text-muted">
                                        <% if (pagination && pagination.totalProducts> 0) { %>
                                            Showing <%= (pagination.currentPage - 1) * 12 + 1 %> to
                                                <%= Math.min(pagination.currentPage * 12, pagination.totalProducts) %>
                                                    of <%= pagination.totalProducts %> products
                                                        <% } else { %>
                                                            Showing <%= products.length %> product<%= products.length
                                                                    !==1 ? 's' : '' %>
                                                                    <% } %>
                                    </small>
                                </div>
                                <% } %>

                                    <!-- Optional: No products found message -->
                                    <% if (products && products.length===0) { %>
                                        <div class="no-products-found text-center py-5">
                                            <div class="mb-3">
                                                <i class="fas fa-search fa-3x text-muted"></i>
                                            </div>
                                            <h4 class="text-muted">No products found</h4>
                                            <p class="text-muted">Try adjusting your filters or search terms</p>
                                            <% if (filters && (filters.category || filters.search || filters.minPrice ||
                                                filters.maxPrice || filters.availability)) { %>
                                                <a href="/shop" class="btn btn-primary">Clear all filters</a>
                                                <% } %>
                                        </div>
                                        <% } %>

                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
/* ------------------------------------------------------------------
   TOAST NOTIFICATIONS
------------------------------------------------------------------ */
function showToast(msg, type = 'success') {
    let box = document.getElementById('toast-container');
    if (!box) {
        box = document.createElement('div');
        box.id = 'toast-container';
        box.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;';
        document.body.appendChild(box);
    }

    const toast = document.createElement('div');
    toast.style.cssText = `
        background:${type === 'success' ? '#4caf50' : '#f44336'};
        color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);
        font-size:14px;font-weight:500;max-width:350px;display:flex;align-items:center;gap:8px;
        opacity:0;transform:translateX(100%);transition:all .3s ease;`;
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${msg}</span>`;

    box.appendChild(toast);

    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, type === 'success' ? 3000 : 5000);
}

/* ------------------------------------------------------------------
   GLOBAL STATE MANAGEMENT
------------------------------------------------------------------ */
window.shopState = {
    wishlistIds: <%- JSON.stringify(userWishlistIds || []) %>, 
    cartCount: <%= cartCount || 0 %>,
    wishlistCount: <%= wishlistCount || 0 %>,
    isAuthenticated: <%= isAuthenticated ? 'true' : 'false' %>
};

/* ------------------------------------------------------------------
   WISHLIST FUNCTIONS
------------------------------------------------------------------ */
async function toggleWishlistFromShop(productId, btn) {
    if (!productId) {
        showToast('Product ID is required', 'error');
        return;
    }

    if (!window.shopState.isAuthenticated) {
        showToast('Please login to manage your wishlist', 'error');
        return;
    }

    btn.disabled = true;

    try {
        const response = await fetch('/api/wishlist/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({ productId })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
            // Update button state immediately
            const icon = btn.querySelector('i');
            if (result.action === 'added') {
                btn.classList.add('active');
                icon.className = 'fas fa-heart text-danger';
                btn.title = 'Remove from Wishlist';
                // Add to local state
                if (!window.shopState.wishlistIds.includes(productId)) {
                    window.shopState.wishlistIds.push(productId);
                }
            } else {
                btn.classList.remove('active');
                icon.className = 'far fa-heart';
                btn.title = 'Add to Wishlist';
                // Remove from local state
                window.shopState.wishlistIds = window.shopState.wishlistIds.filter(id => id !== productId);
            }

            // Update navbar wishlist count
            updateWishlistCount(result.wishlistCount);
            showToast(result.message, 'success');
        } else {
            showToast(result.message || 'Failed to update wishlist', 'error');
        }
    } catch (err) {
        console.error('Error toggling wishlist:', err);
        showToast('Please login to manage your wishlist', 'error');
    } finally {
        btn.disabled = false;
    }
}

// Alias for older calls
function toggleWishlist(id, el) {
    toggleWishlistFromShop(id, el);
}

/* ------------------------------------------------------------------
   CART FUNCTIONS
------------------------------------------------------------------ */
async function addToCart(productId) {
    if (!productId) {
        showToast('Product ID is required', 'error');
        return;
    }

    if (!window.shopState.isAuthenticated) {
        showToast('Please login to add items to cart', 'error');
        return;
    }

    // Get the button that was clicked
    const button = event?.target?.closest('.add-to-cart');
    const originalContent = button?.innerHTML;

    try {
        // Show loading state
        if (button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }

        const response = await fetch('/api/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({ productId, quantity: 1 })
        });

        const result = await response.json();

        if (result.success) {
            // Show success state
            if (button) {
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.style.backgroundColor = '#28a745';

                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.style.backgroundColor = '';
                    button.disabled = false;
                }, 1500);
            }

            // Update cart counter
            updateCartCounter(result.cartCount);
            showToast('Added to cart successfully!', 'success');
        } else {
            // FIXED: Show the actual server error message
            if (button) {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
            
            // Display the specific error message from server (like stock limit)
            showToast(result.message || 'Failed to add to cart', 'error');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        
        if (button) {
            button.innerHTML = originalContent;
            button.disabled = false;
        }
        if (error.message.includes('401') || error.message.includes('unauthorized')) {
            showToast('Please login to add items to cart', 'error');
        } else {
            showToast('Unable to add item to cart. Please try again.', 'error');
        }
    }
}

/* ------------------------------------------------------------------
   NAVIGATION FUNCTIONS
------------------------------------------------------------------ */
function viewProduct(id) {
    if (!id) {
        console.error('Product ID is required');
        return;
    }
    window.location.href = `/product/${id}`;
}

/* ------------------------------------------------------------------
   UPDATE COUNTERS
------------------------------------------------------------------ */
function updateCartCounter(count) {
    window.shopState.cartCount = count || 0;
    const cartElements = document.querySelectorAll('#cartCount, .cart-count');
    cartElements.forEach(elem => {
        elem.textContent = count || '0';
        elem.style.display = count > 0 ? 'flex' : 'none';
    });
}

function updateWishlistCount(count) {
    window.shopState.wishlistCount = count || 0;
    const wishlistElements = document.querySelectorAll('#wishlistCount, .wishlist-count');
    wishlistElements.forEach(elem => {
        elem.textContent = count || '0';
        elem.style.display = count > 0 ? 'flex' : 'none';
    });
}

/* ------------------------------------------------------------------
   INITIALIZATION
------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', function() {
    // Sync initial wishlist button states
    if (window.shopState.isAuthenticated && window.shopState.wishlistIds) {
        document.querySelectorAll('.wishlist-icon').forEach(btn => {
            const productId = btn.getAttribute('data-product-id');
            if (window.shopState.wishlistIds.includes(productId)) {
                btn.classList.add('active');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-heart text-danger';
                }
                btn.title = 'Remove from Wishlist';
            }
        });
    }

    // Initialize counters
    updateCartCounter(window.shopState.cartCount);
    updateWishlistCount(window.shopState.wishlistCount);
});

/* ------------------------------------------------------------------
   PRICE VALIDATION
------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', () => {
    const filterForm = document.getElementById('filterForm');
    const minPriceInput = document.getElementById('minPriceInput');
    const maxPriceInput = document.getElementById('maxPriceInput');
    const minPriceMessage = document.getElementById('minPriceMessage');
    const maxPriceMessage = document.getElementById('maxPriceMessage');
    const priceRangeMsg = document.getElementById('priceRangeMessage');

    function showMsg(el, msg, type = 'error') {
        if (!el) return;
        el.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' :
            type === 'success' ? 'fa-check-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i> ${msg}`;
        el.className = `validation-message ${type} show`;
    }

    function hideMsg(el) {
        if (!el) return;
        el.className = 'validation-message';
        el.innerHTML = '';
    }

    function validatePriceInputs() {
        if (!minPriceInput || !maxPriceInput) return true;

        const min = parseFloat(minPriceInput.value);
        const max = parseFloat(maxPriceInput.value);
        let isValid = true;

        // Reset states
        minPriceInput.className = 'form-control';
        maxPriceInput.className = 'form-control';
        hideMsg(minPriceMessage);
        hideMsg(maxPriceMessage);
        hideMsg(priceRangeMsg);

        // Validate minimum price
        if (minPriceInput.value && (isNaN(min) || min < 0)) {
            minPriceInput.classList.add('error');
            showMsg(minPriceMessage, 'Invalid minimum price');
            isValid = false;
        } else if (minPriceInput.value) {
            showMsg(minPriceMessage, 'Looks good', 'success');
        }

        // Validate maximum price
        if (maxPriceInput.value && (isNaN(max) || max < 0)) {
            maxPriceInput.classList.add('error');
            showMsg(maxPriceMessage, 'Invalid maximum price');
            isValid = false;
        } else if (maxPriceInput.value) {
            showMsg(maxPriceMessage, 'Looks good', 'success');
        }

        // Validate price range
        if (minPriceInput.value && maxPriceInput.value && !isNaN(min) && !isNaN(max)) {
            if (min > max) {
                showMsg(priceRangeMsg, 'Maximum price must be greater than minimum', 'error');
                isValid = false;
            } else if (min === max && min > 0) {
                showMsg(priceRangeMsg, 'Price range is very narrow', 'warning');
            } else {
                showMsg(priceRangeMsg, 'Price range is valid', 'success');
            }
        }

        if (!minPriceInput.value && !maxPriceInput.value) {
            showMsg(priceRangeMsg, 'Enter price range to filter products', 'info');
        }

        return isValid;
    }

    function delayedValidate(input) {
        clearTimeout(input._validationTimer);
        input._validationTimer = setTimeout(validatePriceInputs, 300);
    }

    // Add event listeners
    if (minPriceInput) {
        minPriceInput.addEventListener('input', () => delayedValidate(minPriceInput));
        minPriceInput.addEventListener('focus', validatePriceInputs);
        minPriceInput.addEventListener('blur', validatePriceInputs);
    }

    if (maxPriceInput) {
        maxPriceInput.addEventListener('input', () => delayedValidate(maxPriceInput));
        maxPriceInput.addEventListener('focus', validatePriceInputs);
        maxPriceInput.addEventListener('blur', validatePriceInputs);
    }

    // Validate on form submit
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            if (!validatePriceInputs()) {
                e.preventDefault();
                showToast('Please fix the price range errors before adding filters', 'error');
            }
        });
    }

    // Initial validation
    setTimeout(validatePriceInputs, 500);
});
</script>




    <%- include("../partials/footer") %>
</body>

</html>